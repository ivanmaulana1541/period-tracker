<!DOCTYPE html>
<html>
<head>
<title>ðŸŒ™ Luna Period Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">

<style>
body{
font-family:system-ui;
background:#fff5f8;
padding:20px;
max-width:500px;
margin:auto;
}

h1{
color:#d63384;
text-align:center;
}

.card{
background:white;
padding:15px;
border-radius:12px;
box-shadow:0 3px 8px rgba(0,0,0,0.1);
margin-bottom:15px;
animation:fade .4s ease;
}

@keyframes fade{
from{opacity:0;transform:translateY(10px);}
to{opacity:1;}
}

button{
background:#ff4d88;
color:white;
border:none;
padding:10px;
border-radius:8px;
width:100%;
margin-top:8px;
font-size:16px;
cursor:pointer;
}

button.secondary{
background:#999;
}

input{
width:100%;
padding:10px;
border-radius:8px;
border:1px solid #ddd;
}

li{
display:flex;
justify-content:space-between;
padding:8px 0;
border-bottom:1px solid #eee;
}

.small{
font-size:14px;
color:#666;
}

/* kalender */

#calendar{
display:grid;
grid-template-columns:repeat(7,1fr);
gap:6px;
margin-top:10px;
}

.day{
padding:8px;
text-align:center;
border-radius:8px;
background:#f5f5f5;
font-size:14px;
}

.period{
background:#ff4d88;
color:white;
font-weight:bold;
}

.prediction{
background:#6c5ce7;
color:white;
}
</style>
</head>

<body>

<h1>ðŸŒ™ Luna Period Tracker</h1>

<div class="card">
<input type="date" id="date">
<button onclick="add()">Simpan Tanggal</button>
<button class="secondary" onclick="resetAll()">Reset Data</button>
</div>

<div class="card">
<h3>Prediksi berikutnya</h3>
<div id="prediction">Belum ada data</div>
</div>

<div class="card">
<h3>Statistik</h3>
<div id="stats" class="small"></div>
<canvas id="chart" height="120"></canvas>
</div>

<div class="card">
<h3>Kalender Siklus</h3>
<div id="calendar"></div>
</div>

<div class="card">
<h3>Riwayat</h3>
<ul id="history"></ul>
</div>

<script>
let data=JSON.parse(localStorage.getItem("luna")||"[]");

function save(){
localStorage.setItem("luna",JSON.stringify(data));
}

function add(){
let val=document.getElementById("date").value;
if(!val) return;
data.push(val);
data.sort();
save();
render();
}

function resetAll(){
if(confirm("Hapus semua data?")){
data=[];
save();
render();
}
}

function analyze(){
if(data.length<2) return {avg:0,conf:"rendah",intervals:[]};

let gaps=[];
for(let i=1;i<data.length;i++){
let a=new Date(data[i-1]);
let b=new Date(data[i]);
gaps.push((b-a)/86400000);
}

let avg=gaps.reduce((a,b)=>a+b,0)/gaps.length;
let variance=gaps.map(g=>(g-avg)**2)
.reduce((a,b)=>a+b,0)/gaps.length;

let conf=variance<4?"tinggi":
variance<9?"sedang":"rendah";

return {avg,conf,intervals:gaps};
}

function drawChart(arr){
let c=document.getElementById("chart");
let ctx=c.getContext("2d");
ctx.clearRect(0,0,c.width,c.height);

if(!arr.length) return;

let max=Math.max(...arr)+2;
let step=c.width/(arr.length+1);

ctx.strokeStyle="#ff4d88";
ctx.lineWidth=3;
ctx.beginPath();

arr.forEach((v,i)=>{
let x=step*(i+1);
let y=c.height-(v/max)*c.height;
if(i===0) ctx.moveTo(x,y);
else ctx.lineTo(x,y);
});

ctx.stroke();
}

function buildCalendar(){
let cal=document.getElementById("calendar");
cal.innerHTML="";

let a=analyze();
let avg=Math.round(a.avg);

let today=new Date();
let y=today.getFullYear();
let m=today.getMonth();

let days=new Date(y,m+1,0).getDate();

let predicted=null;
if(data.length && avg){
predicted=new Date(data[data.length-1]);
predicted.setDate(predicted.getDate()+avg);
}

for(let d=1;d<=days;d++){
let cell=document.createElement("div");
cell.className="day";
cell.textContent=d;

let dateStr=new Date(y,m,d)
.toISOString().split("T")[0];

if(data.includes(dateStr))
cell.classList.add("period");

if(predicted &&
predicted.getDate()===d &&
predicted.getMonth()===m)
cell.classList.add("prediction");

cal.appendChild(cell);
}
}

function render(){
let list=document.getElementById("history");
list.innerHTML="";

data.forEach(d=>{
let li=document.createElement("li");
li.textContent=d;
list.appendChild(li);
});

let a=analyze();

if(a.avg){
let next=new Date(data[data.length-1]);
next.setDate(next.getDate()+Math.round(a.avg));

document.getElementById("prediction").innerHTML=
"Perkiraan: <b>"+next.toDateString()+"</b>";

document.getElementById("stats").innerHTML=
"Rata-rata siklus: "+
Math.round(a.avg)+" hari<br>"+
"Confidence: "+a.conf;

drawChart(a.intervals);
}else{
document.getElementById("stats").innerHTML=
"Tambahkan minimal 2 data.";
}

buildCalendar();
}

render();

/* service worker */

if("serviceWorker" in navigator){
navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
