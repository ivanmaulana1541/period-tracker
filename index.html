<!DOCTYPE html>
<html>
<head>
<title>ðŸŒ™ Luna Period Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">

<style>
body{
font-family:system-ui;
background:#fff5f8;
padding:20px;
max-width:520px;
margin:auto;
transition:.3s;
}

.dark{background:#1f1f1f;color:white;}

h1{text-align:center;color:#d63384;}
.dark h1{color:#ff8fb3;}

.card{
background:white;
padding:15px;
border-radius:12px;
box-shadow:0 3px 8px rgba(0,0,0,0.1);
margin-bottom:15px;
transition:.3s;
}

.dark .card{background:#2b2b2b;}

button{
background:#ff4d88;
color:white;
border:none;
padding:12px;
border-radius:8px;
width:100%;
margin-top:8px;
cursor:pointer;
}

.secondary{background:#999;}

.calendar{
display:grid;
grid-template-columns:repeat(7,1fr);
gap:4px;
text-align:center;
}

.day{padding:6px;border-radius:6px;background:#f0f0f0;}
.dark .day{background:#3a3a3a;}

.period{background:#ffb3c9;}
.predicted{background:#ffc4e1;}

.small{font-size:14px;color:#666;}
.dark .small{color:#aaa;}

.lock{
position:fixed;
inset:0;
background:#0008;
display:flex;
justify-content:center;
align-items:center;
}

.lockbox{
background:white;
padding:20px;
border-radius:10px;
}

canvas{width:100%}
</style>
</head>

<body>

<h1>ðŸŒ™ Luna Period Tracker</h1>

<div id="lock" class="lock" style="display:none">
<div class="lockbox">
<h3>ðŸ”’ PIN</h3>
<input type="password" id="pinInput">
<button onclick="unlock()">Unlock</button>
</div>
</div>

<div class="card">
<select id="profile"></select>
<button onclick="newProfile()">+ Profile</button>
<button class="secondary" onclick="toggleDark()">Dark Mode</button>
<button class="secondary" onclick="exportData()">Export</button>
<button class="secondary" onclick="importData()">Import</button>
<button class="secondary" onclick="setPin()">Set PIN</button>
</div>

<div class="card">
<input type="date" id="date">
<button onclick="add()">Tambah Periode</button>
<button onclick="notifyTest()">Test Reminder</button>
</div>

<div class="card">
<h3>Prediksi berikutnya</h3>
<div id="prediction"></div>
<div id="countdown" class="small"></div>
</div>

<div class="card">
<h3>Statistik</h3>
<div id="stats"></div>
<canvas id="chart"></canvas>
</div>

<div class="card">
<h3>Kalender</h3>
<div id="calendar" class="calendar"></div>
</div>

<script>

// ---------- DARK MODE ----------
if(localStorage.getItem("dark")==="1")
document.body.classList.add("dark");

function toggleDark(){
document.body.classList.toggle("dark");
localStorage.setItem("dark",
document.body.classList.contains("dark")?"1":"0");
}

// ---------- PIN LOCK ----------
function setPin(){
let pin=prompt("Set PIN (4 digit)");
if(pin) localStorage.setItem("lunaPin",pin);
}

function unlock(){
let pin=document.getElementById("pinInput").value;
if(pin===localStorage.getItem("lunaPin"))
document.getElementById("lock").style.display="none";
}

if(localStorage.getItem("lunaPin"))
document.getElementById("lock").style.display="flex";

// ---------- PROFILE ----------
let profiles=JSON.parse(localStorage.getItem("lunaProfiles"))||{Default:[]};
let current="Default";

function saveProfiles(){
localStorage.setItem("lunaProfiles",JSON.stringify(profiles));
}

function refreshProfiles(){
let sel=document.getElementById("profile");
sel.innerHTML="";
Object.keys(profiles).forEach(p=>{
let o=document.createElement("option");
o.textContent=p;
sel.appendChild(o);
});
sel.value=current;
}

document.getElementById("profile").onchange=e=>{
current=e.target.value;
render();
};

function newProfile(){
let n=prompt("Nama profile?");
if(!n) return;
profiles[n]=[];
saveProfiles();
refreshProfiles();
}

// ---------- DATA ----------
function getData(){return profiles[current];}

function add(){
let d=document.getElementById("date").value;
if(!d) return;
profiles[current].push(d);
profiles[current].sort();
saveProfiles();
render();
}

// ---------- CALC ----------
function avgCycle(){
let d=getData();
if(d.length<2) return null;

let g=[];
for(let i=1;i<d.length;i++){
let a=new Date(d[i-1]);
let b=new Date(d[i]);
g.push((b-a)/86400000);
}

return Math.round(g.reduce((a,b)=>a+b)/g.length);
}

function nextDate(){
let avg=avgCycle();
if(!avg) return null;
let last=new Date(getData().at(-1));
last.setDate(last.getDate()+avg);
return last;
}

// ---------- REMINDER ----------
function notifyTest(){
Notification.requestPermission().then(()=>{
new Notification("ðŸŒ™ Luna Reminder","Periode akan datang!");
});
}

function checkReminder(){
let n=nextDate();
if(!n) return;

let diff=Math.ceil((n-new Date())/86400000);

if(diff===1){
Notification.requestPermission().then(()=>{
new Notification("ðŸŒ™ Luna Reminder","Besok perkiraan periode!");
});
}
}

setInterval(checkReminder,3600000);

// ---------- UI ----------
function renderCalendar(){
let cal=document.getElementById("calendar");
cal.innerHTML="";

let now=new Date();
let days=new Date(now.getFullYear(),now.getMonth()+1,0).getDate();

let marks=getData().map(d=>new Date(d).getDate());
let next=nextDate();

for(let i=1;i<=days;i++){
let div=document.createElement("div");
div.className="day";
div.innerText=i;

if(marks.includes(i)) div.classList.add("period");
if(next && next.getDate()==i) div.classList.add("predicted");

cal.appendChild(div);
}
}

function drawChart(){
let canvas=document.getElementById("chart");
let ctx=canvas.getContext("2d");
canvas.height=120;
ctx.clearRect(0,0,canvas.width,canvas.height);

let d=getData();
if(d.length<2) return;

let gaps=[];
for(let i=1;i<d.length;i++){
let a=new Date(d[i-1]);
let b=new Date(d[i]);
gaps.push((b-a)/86400000);
}

let max=Math.max(...gaps);
let w=canvas.width/gaps.length;

ctx.strokeStyle="#ff4d88";
ctx.beginPath();

gaps.forEach((g,i)=>{
let x=i*w;
let y=120-(g/max)*100;
ctx.lineTo(x,y);
});

ctx.stroke();
}

// ---------- EXPORT / IMPORT ----------
function exportData(){
let blob=new Blob([JSON.stringify(profiles)],{type:"application/json"});
let a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="luna-backup.json";
a.click();
}

function importData(){
let input=document.createElement("input");
input.type="file";
input.onchange=e=>{
let reader=new FileReader();
reader.onload=()=>{
profiles=JSON.parse(reader.result);
saveProfiles();
refreshProfiles();
render();
};
reader.readAsText(e.target.files[0]);
};
input.click();
}

// ---------- RENDER ----------
function render(){
let avg=avgCycle();
let next=nextDate();

document.getElementById("prediction").innerText=
next?next.toLocaleDateString():"Belum cukup data";

document.getElementById("countdown").innerText=
next?Math.ceil((next-new Date())/86400000)+" hari lagi":"";

document.getElementById("stats").innerText=
avg?`Rata-rata siklus: ${avg} hari`:"";

renderCalendar();
drawChart();
}

// ---------- INIT ----------
refreshProfiles();
render();

</script>

</body>
</html>
