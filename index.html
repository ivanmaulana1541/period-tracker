<!DOCTYPE html>
<html>
<head>
<title>ðŸŒ™ Luna Period Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">

<style>
body{
font-family:system-ui;
background:#fff5f8;
padding:20px;
max-width:520px;
margin:auto;
transition:.3s;
}

.dark{
background:#1f1f1f;
color:white;
}

h1{text-align:center;color:#d63384;}
.dark h1{color:#ff8fb3;}

.card{
background:white;
padding:15px;
border-radius:12px;
box-shadow:0 3px 8px rgba(0,0,0,0.1);
margin-bottom:15px;
animation:fade .4s ease;
}

.dark .card{
background:#2b2b2b;
}

@keyframes fade{
from{opacity:0;transform:translateY(10px);}
to{opacity:1;}
}

button{
background:#ff4d88;
color:white;
border:none;
padding:10px;
border-radius:8px;
width:100%;
margin-top:8px;
font-size:16px;
cursor:pointer;
}

.secondary{background:#777;}

input{
width:100%;
padding:10px;
border-radius:8px;
border:1px solid #ddd;
}

.small{font-size:14px;color:#666;}
.dark .small{color:#aaa;}

#calendarNav{
display:flex;
justify-content:space-between;
align-items:center;
margin-bottom:10px;
}

#calendar{
display:grid;
grid-template-columns:repeat(7,1fr);
gap:6px;
}

.day{
padding:8px;
text-align:center;
border-radius:8px;
background:#f5f5f5;
font-size:14px;
position:relative;
}

.dark .day{background:#3a3a3a;}

.today{outline:2px solid #333;}

.period{background:#ff4d88;color:white;}

.prediction{background:#6c5ce7;color:white;}

.ovulation{background:#00b894;color:white;}

.mood{
position:absolute;
bottom:2px;
right:2px;
font-size:12px;
}
</style>
</head>

<body>

<h1>ðŸŒ™ Luna Period Tracker</h1>

<div class="card">
<input type="date" id="date">
<button onclick="add()">Simpan Tanggal + Mood</button>
<button class="secondary" onclick="resetAll()">Reset Data</button>
<button class="secondary" onclick="toggleDark()">ðŸŒ— Dark Mode</button>
</div>

<div class="card">
<h3>AI Prediction</h3>
<div id="prediction">Belum ada data</div>
</div>

<div class="card">
<h3>Statistik AI</h3>
<div id="stats" class="small"></div>
<canvas id="chart" height="120"></canvas>
</div>

<div class="card">
<h3>Kalender Profesional</h3>

<div id="calendarNav">
<button onclick="changeMonth(-1)">â—€</button>
<b id="monthLabel"></b>
<button onclick="changeMonth(1)">â–¶</button>
</div>

<div id="calendar"></div>
</div>

<div class="card">
<h3>Riwayat</h3>
<ul id="history"></ul>
</div>

<script>

// DARK MODE
if(localStorage.getItem("dark")==="1")
document.body.classList.add("dark");

function toggleDark(){
document.body.classList.toggle("dark");
localStorage.setItem("dark",
document.body.classList.contains("dark")?"1":"0");
}

// DATA
let data=JSON.parse(localStorage.getItem("luna")||"[]");
let current=new Date();

function save(){
localStorage.setItem("luna",JSON.stringify(data));
}

function add(){
let date=document.getElementById("date").value;
if(!date)return;

let mood=prompt("Mood hari ini? ðŸ˜ŠðŸ˜´ðŸ˜¡â¤ï¸","");
data.push({date,mood});
data.sort((a,b)=>a.date.localeCompare(b.date));
save();
render();
}

function resetAll(){
if(confirm("Hapus semua data?")){
data=[];
save();
render();
}
}

// AI LEARNING
function analyze(){
if(data.length<2) return {avg:0,conf:"rendah",gaps:[]};

let gaps=[];
for(let i=1;i<data.length;i++){
let a=new Date(data[i-1].date);
let b=new Date(data[i].date);
gaps.push((b-a)/86400000);
}

// weighted learning
let total=0,weight=0;
gaps.forEach((v,i)=>{
let w=i+1;
total+=v*w;
weight+=w;
});

let avg=total/weight;

let variance=gaps.map(g=>(g-avg)**2)
.reduce((a,b)=>a+b,0)/gaps.length;

let conf=variance<4?"tinggi":
variance<9?"sedang":"rendah";

return {avg,conf,gaps};
}

function drawChart(arr){
let c=document.getElementById("chart");
let ctx=c.getContext("2d");
ctx.clearRect(0,0,c.width,c.height);

if(!arr.length)return;

let max=Math.max(...arr)+2;
let step=c.width/(arr.length+1);

ctx.strokeStyle="#ff4d88";
ctx.lineWidth=3;
ctx.beginPath();

arr.forEach((v,i)=>{
let x=step*(i+1);
let y=c.height-(v/max)*c.height;
if(i===0)ctx.moveTo(x,y);
else ctx.lineTo(x,y);
});

ctx.stroke();
}

// CALENDAR
function buildCalendar(){
let cal=document.getElementById("calendar");
cal.innerHTML="";

let y=current.getFullYear();
let m=current.getMonth();

document.getElementById("monthLabel").innerText=
current.toLocaleString("default",{month:"long",year:"numeric"});

let days=new Date(y,m+1,0).getDate();
let today=new Date();

let a=analyze();
let avg=Math.round(a.avg);

let predicted=null,ovu=null;

if(data.length && avg){
predicted=new Date(data[data.length-1].date);
predicted.setDate(predicted.getDate()+avg);

ovu=new Date(predicted);
ovu.setDate(predicted.getDate()-14);
}

for(let d=1;d<=days;d++){
let cell=document.createElement("div");
cell.className="day";
cell.textContent=d;

let date=new Date(y,m,d);
let iso=date.toISOString().split("T")[0];

if(date.toDateString()===today.toDateString())
cell.classList.add("today");

let record=data.find(x=>x.date===iso);

if(record){
cell.classList.add("period");
if(record.mood){
let mood=document.createElement("div");
mood.className="mood";
mood.textContent=record.mood;
cell.appendChild(mood);
}
}

if(predicted &&
date.toDateString()===predicted.toDateString())
cell.classList.add("prediction");

if(ovu &&
date.toDateString()===ovu.toDateString())
cell.classList.add("ovulation");

cal.appendChild(cell);
}
}

function changeMonth(n){
current.setMonth(current.getMonth()+n);
buildCalendar();
}

// RENDER
function render(){
let list=document.getElementById("history");
list.innerHTML="";

data.forEach(d=>{
let li=document.createElement("li");
li.textContent=d.date+" "+(d.mood||"");
list.appendChild(li);
});

let a=analyze();

if(a.avg){
let next=new Date(data[data.length-1].date);
next.setDate(next.getDate()+Math.round(a.avg));

let ovu=new Date(next);
ovu.setDate(next.getDate()-14);

document.getElementById("prediction").innerHTML=
"Next period: <b>"+next.toDateString()+"</b><br>"+
"Ovulation: <b>"+ovu.toDateString()+"</b>";

document.getElementById("stats").innerHTML=
"AI avg cycle: "+Math.round(a.avg)+" hari<br>"+
"Confidence: "+a.conf;

drawChart(a.gaps);
}else{
document.getElementById("stats").innerText=
"Tambahkan minimal 2 data.";
}

buildCalendar();
}

render();

if("serviceWorker" in navigator){
navigator.serviceWorker.register("service-worker.js");
}

</script>

</body>
</html>
