<!DOCTYPE html>
<html>
<head>
<title>ðŸŒ™ Luna Period Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">

<style>
body{
font-family:system-ui;
background:#fff5f8;
padding:20px;
max-width:520px;
margin:auto;
transition:.3s;
}

.dark{
background:#1f1f1f;
color:white;
}

h1{
text-align:center;
color:#d63384;
}

.dark h1{color:#ff8fb3}

.card{
background:white;
padding:15px;
border-radius:12px;
box-shadow:0 3px 8px rgba(0,0,0,0.1);
margin-bottom:15px;
animation:fade .4s ease;
transition:.3s;
}

.dark .card{
background:#2b2b2b;
}

@keyframes fade{
from{opacity:0;transform:translateY(10px)}
to{opacity:1;transform:translateY(0)}
}

button{
background:#ff4d88;
color:white;
border:none;
padding:12px;
border-radius:8px;
width:100%;
margin-top:8px;
font-size:16px;
cursor:pointer;
}

button.secondary{
background:#999;
}

input{
width:100%;
padding:10px;
border-radius:8px;
border:1px solid #ddd;
}

.calendar{
display:grid;
grid-template-columns:repeat(7,1fr);
gap:4px;
text-align:center;
}

.day{
padding:6px;
border-radius:6px;
background:#f0f0f0;
font-size:14px;
}

.dark .day{
background:#3a3a3a;
}

.period{background:#ffb3c9}
.ovulation{background:#9be7ff}
.predicted{background:#ffc4e1}

li{
display:flex;
justify-content:space-between;
padding:8px 0;
border-bottom:1px solid #eee;
}

.small{
font-size:14px;
color:#666;
}

.dark .small{color:#aaa}

canvas{width:100%}
</style>
</head>

<body>

<h1>ðŸŒ™ Luna Period Tracker</h1>

<div class="card">
<input type="date" id="date">
<button onclick="add()">Simpan Tanggal</button>
<button class="secondary" onclick="resetData()">Reset</button>
<button class="secondary" onclick="toggleDark()">Dark Mode</button>
<button class="secondary" onclick="exportData()">Export Data</button>
</div>

<div class="card">
<h3>Prediksi berikutnya</h3>
<div id="prediction">Belum ada data</div>
<div class="small" id="countdown"></div>
</div>

<div class="card">
<h3>Statistik</h3>
<div id="stats"></div>
<canvas id="chart"></canvas>
</div>

<div class="card">
<h3>Kalender bulan ini</h3>
<div id="calendar" class="calendar"></div>
</div>

<div class="card">
<h3>Riwayat</h3>
<ul id="history"></ul>
</div>

<script>
if("serviceWorker" in navigator){
navigator.serviceWorker.register("service-worker.js");
}

let data = JSON.parse(localStorage.getItem("luna")) || [];

function save(){
localStorage.setItem("luna", JSON.stringify(data));
}

function add(){
let date=document.getElementById("date").value;
if(!date) return;

let mood=prompt("Mood hari ini? ðŸ˜Š","");
data.push({date,mood});
data.sort((a,b)=>new Date(a.date)-new Date(b.date));

save();
render();
}

function resetData(){
if(confirm("Hapus semua data?")){
data=[];
save();
render();
}
}

function avgCycle(){
if(data.length<2) return null;

let gaps=[];
for(let i=1;i<data.length;i++){
let d1=new Date(data[i-1].date);
let d2=new Date(data[i].date);
gaps.push((d2-d1)/(1000*60*60*24));
}

return Math.round(gaps.reduce((a,b)=>a+b)/gaps.length);
}

function nextDate(){
let avg=avgCycle();
if(!avg) return null;

let last=new Date(data[data.length-1].date);
last.setDate(last.getDate()+avg);
return last;
}

function ovulationDate(){
let next=nextDate();
if(!next) return null;
next.setDate(next.getDate()-14);
return next;
}

function countdown(){
let next=nextDate();
if(!next) return "";

let diff=Math.ceil((next-new Date())/(1000*60*60*24));
return diff>0?`${diff} hari lagi`: "Hari ini!";
}

function renderHistory(){
let list=document.getElementById("history");
list.innerHTML="";

data.slice().reverse().forEach(item=>{
let li=document.createElement("li");
li.innerHTML=`
<div>
${new Date(item.date).toLocaleDateString()}
<div class="small">${item.mood||""}</div>
</div>`;
list.appendChild(li);
});
}

function renderCalendar(){
let cal=document.getElementById("calendar");
cal.innerHTML="";

let now=new Date();
let year=now.getFullYear();
let month=now.getMonth();
let days=new Date(year,month+1,0).getDate();

let periodDays=data.map(d=>new Date(d.date).getDate());

let next=nextDate();
let ovu=ovulationDate();

for(let i=1;i<=days;i++){
let div=document.createElement("div");
div.className="day";
div.innerText=i;

if(periodDays.includes(i)) div.classList.add("period");

if(next && next.getDate()==i) div.classList.add("predicted");

if(ovu && ovu.getDate()==i) div.classList.add("ovulation");

cal.appendChild(div);
}
}

function drawChart(){
let canvas=document.getElementById("chart");
let ctx=canvas.getContext("2d");
canvas.height=120;
ctx.clearRect(0,0,canvas.width,canvas.height);

if(data.length<2) return;

let gaps=[];
for(let i=1;i<data.length;i++){
let d1=new Date(data[i-1].date);
let d2=new Date(data[i].date);
gaps.push((d2-d1)/(1000*60*60*24));
}

let max=Math.max(...gaps);
let w=canvas.width/gaps.length;

ctx.strokeStyle="#ff4d88";
ctx.beginPath();

gaps.forEach((g,i)=>{
let x=i*w;
let y=120-(g/max)*100;
ctx.lineTo(x,y);
});

ctx.stroke();
}

function exportData(){
let blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
let a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="luna-data.json";
a.click();
}

function toggleDark(){
document.body.classList.toggle("dark");
}

function render(){
renderHistory();
renderCalendar();
drawChart();

let avg=avgCycle();

document.getElementById("prediction").innerText=
nextDate()?nextDate().toLocaleDateString():"Belum cukup data";

document.getElementById("countdown").innerText=countdown();

document.getElementById("stats").innerText=
avg?`Rata-rata siklus: ${avg} hari`:"Belum cukup data";
}

render();
</script>

</body>
</html>
