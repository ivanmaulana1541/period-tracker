<!DOCTYPE html>
<html>
<head>
<title>ðŸŒ™ Luna Period Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">

<style>
body{
font-family:system-ui;
background:#fff5f8;
padding:20px;
max-width:560px;
margin:auto;
transition:.3s;
}

.dark{background:#1f1f1f;color:white;}

h1{text-align:center;color:#d63384;}
.dark h1{color:#ff8fb3;}

.card{
background:white;
padding:15px;
border-radius:12px;
box-shadow:0 3px 8px rgba(0,0,0,0.1);
margin-bottom:15px;
transition:.3s;
}

.dark .card{background:#2b2b2b;}

button{
background:#ff4d88;
color:white;
border:none;
padding:12px;
border-radius:8px;
width:100%;
margin-top:8px;
cursor:pointer;
}

.secondary{background:#999;}

.calendar{
display:grid;
grid-template-columns:repeat(7,1fr);
gap:4px;
text-align:center;
}

.header{
font-weight:bold;
font-size:13px;
opacity:.7;
}

.day{
padding:8px 0;
border-radius:6px;
background:#f0f0f0;
}

.dark .day{background:#3a3a3a;}

.period{background:#ffb3c9;}
.predicted{background:#ffc4e1;}
.fertile{background:#b8f0ff;}

.small{font-size:14px;color:#666;}
.dark .small{color:#aaa;}

canvas{width:100%}
</style>
</head>

<body>

<h1>ðŸŒ™ Luna Period Tracker</h1>

<div class="card">
<select id="profile"></select>
<button onclick="newProfile()">+ Profile</button>
<button class="secondary" onclick="toggleDark()">Dark Mode</button>
</div>

<div class="card">
<input type="date" id="date">
<button onclick="add()">Tambah Periode</button>
</div>

<div class="card">
<h3>AI Dashboard</h3>
<div id="dashboard"></div>
</div>

<div class="card">
<h3>Prediksi berikutnya</h3>
<div id="prediction"></div>
<div id="phase" class="small"></div>
</div>

<div class="card">
<h3>Kalender Profesional</h3>
<div id="calendar" class="calendar"></div>
</div>

<div class="card">
<h3>Statistik</h3>
<div id="stats"></div>
<canvas id="chart"></canvas>
</div>

<script>

// ---------- DARK MODE ----------
if(localStorage.getItem("dark")==="1")
document.body.classList.add("dark");

function toggleDark(){
document.body.classList.toggle("dark");
localStorage.setItem("dark",
document.body.classList.contains("dark")?"1":"0");
}

// ---------- PROFILE ----------
let profiles=JSON.parse(localStorage.getItem("lunaProfiles"))||{Default:[]};
let current="Default";

function saveProfiles(){
localStorage.setItem("lunaProfiles",JSON.stringify(profiles));
}

function refreshProfiles(){
let sel=document.getElementById("profile");
sel.innerHTML="";
Object.keys(profiles).forEach(p=>{
let o=document.createElement("option");
o.textContent=p;
sel.appendChild(o);
});
sel.value=current;
}

document.getElementById("profile").onchange=e=>{
current=e.target.value;
render();
};

function newProfile(){
let n=prompt("Nama profile?");
if(!n) return;
profiles[n]=[];
saveProfiles();
refreshProfiles();
}

// ---------- DATA ----------
function getData(){return profiles[current];}

function add(){
let d=document.getElementById("date").value;
if(!d) return;
profiles[current].push(d);
profiles[current].sort();
saveProfiles();
render();
}

// ---------- AI CALC ----------
function gaps(){
let d=getData();
let g=[];
for(let i=1;i<d.length;i++){
let a=new Date(d[i-1]);
let b=new Date(d[i]);
g.push((b-a)/86400000);
}
return g;
}

function weightedCycle(){
let g=gaps();
if(!g.length) return null;

let total=0, weight=0;

g.forEach((v,i)=>{
let w=i+1;
total+=v*w;
weight+=w;
});

return total/weight;
}

function trendAdjust(){
let g=gaps();
if(g.length<3) return 0;

let last=g.slice(-3);
let avgRecent=last.reduce((a,b)=>a+b)/last.length;
let avgAll=g.reduce((a,b)=>a+b)/g.length;

return avgRecent-avgAll;
}

function predictedCycle(){
let base=weightedCycle();
if(!base) return null;

return Math.round(base+trendAdjust()*0.5);
}

function confidence(){
let g=gaps();
if(!g.length) return "";

let avg=predictedCycle();
let variance=g.reduce((s,x)=>s+Math.abs(x-avg),0)/g.length;

if(variance<2) return "Tinggi";
if(variance<5) return "Sedang";
return "Rendah";
}

function nextDate(){
let avg=predictedCycle();
if(!avg) return null;

let last=new Date(getData().at(-1));
last.setDate(last.getDate()+avg);
return last;
}

// ---------- PHASE ----------
function phase(){
let next=nextDate();
if(!next) return "";

let diff=Math.ceil((next-new Date())/86400000);

if(diff<=5 && diff>=0) return "Menjelang periode";
if(diff>5 && diff<=14) return "Fase subur";
return "Fase aman";
}

// ---------- DASHBOARD ----------
function dashboard(){
let avg=predictedCycle();
if(!avg) return "Tambahkan data untuk analisis.";

return `
Prediksi AI: ${avg} hari<br>
Confidence: ${confidence()}
`;
}

// ---------- CALENDAR ----------
function renderCalendar(){
let cal=document.getElementById("calendar");
cal.innerHTML="";

let days=["Sen","Sel","Rab","Kam","Jum","Sab","Min"];
days.forEach(d=>{
let h=document.createElement("div");
h.className="header";
h.innerText=d;
cal.appendChild(h);
});

let now=new Date();
let y=now.getFullYear();
let m=now.getMonth();

let first=new Date(y,m,1).getDay();
first=(first+6)%7;

for(let i=0;i<first;i++){
cal.appendChild(document.createElement("div"));
}

let total=new Date(y,m+1,0).getDate();

let marks=getData().map(d=>new Date(d).getDate());
let next=nextDate();

let fertileStart=next?next.getDate()-14:null;

for(let i=1;i<=total;i++){
let div=document.createElement("div");
div.className="day";
div.innerText=i;

if(marks.includes(i)) div.classList.add("period");
if(next && next.getDate()==i) div.classList.add("predicted");

if(fertileStart && i>=fertileStart && i<fertileStart+5)
div.classList.add("fertile");

cal.appendChild(div);
}
}

// ---------- CHART ----------
function drawChart(){
let canvas=document.getElementById("chart");
let ctx=canvas.getContext("2d");
canvas.height=120;
ctx.clearRect(0,0,canvas.width,canvas.height);

let g=gaps();
if(!g.length) return;

let max=Math.max(...g);
let w=canvas.width/g.length;

ctx.strokeStyle="#ff4d88";
ctx.beginPath();

g.forEach((x,i)=>{
let px=i*w;
let py=120-(x/max)*100;
ctx.lineTo(px,py);
});

ctx.stroke();
}

// ---------- RENDER ----------
function render(){
let next=nextDate();

document.getElementById("dashboard").innerHTML=dashboard();

document.getElementById("prediction").innerText=
next?next.toLocaleDateString():"Belum cukup data";

document.getElementById("phase").innerText=phase();

document.getElementById("stats").innerText=
predictedCycle()?`Confidence: ${confidence()}`:"";

renderCalendar();
drawChart();
}

// ---------- INIT ----------
refreshProfiles();
render();

</script>

</body>
</html>
